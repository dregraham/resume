name: Terraform Provision

on:
  repository_dispatch:
    types: [terraform-provision, terraform-destroy]

jobs:
  terraform:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      TF_WORKING_DIR: ./terraform

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/TerraformExecutionRole
          role-session-name: GitHubTerraformSession
          aws-region: ${{ github.event.client_payload.region }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      # === APPLY INFRA ===
      - name: Terraform Apply
        if: github.event.client_payload.terraform_action == 'provision'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform apply -auto-approve \
            -var="request_id=${{ github.event.client_payload.requestId }}" \
            -var="region=${{ github.event.client_payload.region }}" \
            -var="state_key=${{ github.event.client_payload.stateKey }}"

      - name: Update DynamoDB when provision complete
        if: github.event.client_payload.terraform_action == 'provision'
        run: |
          aws dynamodb update-item \
            --table-name multicloud_iac_runs \
            --key "{\"id\": {\"S\": \"${{ github.event.client_payload.requestId }}\"}}" \
            --update-expression "SET status = :s" \
            --expression-attribute-values "{\":s\": {\"S\": \"complete\"}}"

      # === CAPTURE ENVIRONMENT OUTPUTS ===
      - name: Save Terraform outputs to JSON
        if: github.event.client_payload.terraform_action == 'provision'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform output -json > env-details.json

      - name: Upload env details to S3
        if: github.event.client_payload.terraform_action == 'provision'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          aws s3 cp env-details.json \
            s3://dre-multicloud-demo-site/created_envs/${{ github.event.client_payload.requestId }}-outputs.json

      # === AUTO DESTROY PHASE 1 (10 MIN DELAY) ===
      - name: Auto Destroy VPC, Subnet, EC2
        id: auto_destroy
        if: github.event.client_payload.terraform_action == 'provision'
        working-directory: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true
        run: |
          sleep 600
          terraform destroy -auto-approve \
            -target=aws_instance.main \
            -target=aws_subnet.main \
            -target=aws_vpc.main

      # === RETRY ON FAILURE (DESTROY EVERYTHING) ===
      - name: Wait extra 10 minutes before retry if destroy failed
        if: >
          github.event.client_payload.terraform_action == 'provision' &&
          steps.auto_destroy.outcome == 'failure'
        run: sleep 600

      - name: Force Final Destroy (No Targets â€“ Full Cleanup)
        if: >
          github.event.client_payload.terraform_action == 'provision' &&
          steps.auto_destroy.outcome == 'failure'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform destroy -auto-approve -lock=false

      # === DIRECT DESTROY PATH ===
      - name: Terraform Destroy (direct request)
        if: github.event.client_payload.terraform_action == 'destroy'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform destroy -auto-approve
