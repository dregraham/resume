name: Terraform AWS On-Demand

on:
  repository_dispatch:
    types: [terraform-provision]

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-aws-on-demand-${{ github.event.client_payload.request_id || github.run_id }}
  cancel-in-progress: false

jobs:
  provision:
    name: Provision and Teardown
    runs-on: ubuntu-latest
    env:
      TF_WORKDIR: terraform
      TF_IN_AUTOMATION: 1
      TF_VAR_aws_region: ${{ github.event.client_payload.aws_region || 'us-east-2' }}
      REQUEST_ID: ${{ github.event.client_payload.request_id || github.run_id }}
      MODE: ${{ github.event.client_payload.mode || 'provision' }}
      STATE_KEY: ${{ github.event.client_payload.state_key || '' }}
    steps:
      - name: Acknowledge request
        run: |
          echo "Request ID: $REQUEST_ID"
          echo "Target region: $TF_VAR_aws_region"
          echo "Workflow mode: $MODE"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Export Terraform environment
        run: |
          echo "TF_STATE_BUCKET=${{ secrets.TF_STATE_BUCKET }}" >> "$GITHUB_ENV"
          echo "TF_LOCK_TABLE=${{ secrets.TF_LOCK_TABLE }}" >> "$GITHUB_ENV"
          echo "TF_VAR_github_token=${{ secrets.TF_VAR_GITHUB_TOKEN }}" >> "$GITHUB_ENV"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-2
          audience: sts.amazonaws.com

      - name: Derive backend key
        run: |
          if [ -z "$STATE_KEY" ]; then
            derived_key="multicloud-iac/aws/${REQUEST_ID}.tfstate"
          else
            derived_key="$STATE_KEY"
          fi
          echo "STATE_KEY=$derived_key" >> "$GITHUB_ENV"
          echo "Using backend state key: $derived_key"

      - name: Terraform Init
        run: |
          terraform init -input=false \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=${{ github.event.client_payload.aws_region || 'us-east-2' }}" \
            -backend-config="dynamodb_table=${TF_LOCK_TABLE}" \
            -backend-config="encrypt=true"
        working-directory: terraform

      - name: Terraform Apply
        if: env.MODE == 'provision'
        run: terraform apply -input=false -auto-approve
        working-directory: terraform

      - name: Capture outputs
        if: env.MODE == 'provision'
        run: terraform output -json > terraform-outputs.json
        working-directory: terraform

      - name: Upload outputs
        if: env.MODE == 'provision'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ env.REQUEST_ID }}
          path: terraform/terraform-outputs.json

      - name: Wait before destroy
        if: env.MODE == 'provision'
        run: sleep 120

      - name: Terraform Destroy
        if: env.MODE == 'provision'
        run: terraform destroy -input=false -auto-approve
        working-directory: terraform

      - name: Terraform Destroy (manual)
        if: env.MODE == 'destroy'
        run: terraform destroy -input=false -auto-approve
        working-directory: terraform

      - name: Cleanup plan artifacts
        run: rm -f terraform-outputs.json
        working-directory: terraform
