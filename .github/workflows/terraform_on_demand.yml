name: Terraform On Demand

on:
  repository_dispatch:
    types:
      - terraform_on_demand

permissions:
  contents: read
  id-token: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      RUN_TABLE: multicloud_iac_runs
      AWS_REGION: us-east-2
      RUN_ID: ${{ github.event.client_payload.runId }}
      ACTION: ${{ github.event.client_payload.action }}
      CLOUDS: ${{ github.event.client_payload.clouds }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.8.5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # --- Update DynamoDB status to "in_progress"
      - name: Mark run in_progress
        run: |
          aws dynamodb update-item \
            --table-name "$RUN_TABLE" \
            --key '{"runId":{"S":"'$RUN_ID'"}}' \
            --update-expression 'SET #s = :s' \
            --expression-attribute-names '{"#s":"status"}' \
            --expression-attribute-values '{":s":{"S":"in_progress"}}'

      # --- Terraform Init
      - name: Terraform Init
        working-directory: terraform
        run: terraform init -input=false

      # --- Terraform Plan (apply only)
      - name: Terraform Plan
        if: env.ACTION == 'apply'
        working-directory: terraform
        run: |
          terraform plan -input=false -no-color -out=tfplan | tee ../plan.txt || echo "PLAN_FAILED" >> ../plan.txt

      # --- Terraform Apply (apply only)
      - name: Terraform Apply
        if: env.ACTION == 'apply'
        working-directory: terraform
        run: |
          terraform apply -input=false -no-color -auto-approve | tee ../apply.txt || echo "APPLY_FAILED" >> ../apply.txt

      # --- Terraform Destroy (destroy only)
      - name: Terraform Destroy
        if: env.ACTION == 'destroy'
        working-directory: terraform
        run: |
          terraform destroy -input=false -no-color -auto-approve | tee ../destroy.txt || echo "DESTROY_FAILED" >> ../destroy.txt

      # --- Determine final status
      - name: Determine final status
        run: |
          if [ "$ACTION" = "apply" ]; then
            if grep -q APPLY_FAILED apply.txt; then
              echo "FINAL_STATUS=failed" >> $GITHUB_ENV
            else
              echo "FINAL_STATUS=applied" >> $GITHUB_ENV
            fi
          else
            if grep -q DESTROY_FAILED destroy.txt; then
              echo "FINAL_STATUS=failed" >> $GITHUB_ENV
            else
              echo "FINAL_STATUS=destroyed" >> $GITHUB_ENV
            fi
          fi

      # --- Upload logs & final status to DynamoDB
      - name: Upload logs and final status
        run: |
          LOG_DATA=$(cat plan.txt apply.txt destroy.txt 2>/dev/null || echo "No logs")
          TRUNCATED=$(echo "$LOG_DATA" | head -c 380000)
          aws dynamodb update-item \
            --table-name "$RUN_TABLE" \
            --key '{"runId":{"S":"'$RUN_ID'"}}' \
            --update-expression 'SET #s = :s, logs = :l' \
            --expression-attribute-names '{"#s":"status"}' \
            --expression-attribute-values '{":s":{"S":"'$FINAL_STATUS'"}, ":l":{"S":"'"${TRUNCATED}"'"}}'

      # --- Mark failure if non-zero exit
      - name: Mark failure on non-zero
        if: failure()
        run: echo "Workflow encountered errors; status recorded."
