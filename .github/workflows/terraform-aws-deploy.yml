name: Terraform AWS Deploy

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Terraform action to run"
        required: true
        default: plan
        type: choice
        options:
          - plan
          - apply
          - destroy
      default_region:
        description: "AWS region for this run"
        required: true
        default: us-east-2
      environment_name:
        description: "GitHub environment protecting apply/destroy"
        required: false
        default: aws-terraform
      github_token_secret:
        description: "Secret name holding the workflow dispatch token"
        required: false
        default: TF_VAR_GITHUB_TOKEN

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-aws-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    env:
      TF_WORKDIR: terraform
      TF_VAR_aws_region: ${{ inputs.default_region }}
      TF_IN_AUTOMATION: 1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Export Terraform environment
        run: |
          echo "TF_STATE_BUCKET=${{ secrets.TF_STATE_BUCKET }}" >> "$GITHUB_ENV"
          echo "TF_LOCK_TABLE=${{ secrets.TF_LOCK_TABLE }}" >> "$GITHUB_ENV"
          echo "TF_VAR_github_token=${{ secrets[inputs.github_token_secret] }}" >> "$GITHUB_ENV"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: ${{ github.job }}
          aws-region: ${{ inputs.default_region }}

      - name: Terraform Init
        run: |
          terraform init -input=false \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=multicloud-iac/aws/terraform.tfstate" \
            -backend-config="region=${{ inputs.default_region }}" \
            -backend-config="dynamodb_table=${TF_LOCK_TABLE}" \
            -backend-config="encrypt=true"
        working-directory: terraform

      - name: Terraform Plan
        run: |
          if [ "${{ inputs.action }}" = "destroy" ]; then
            terraform plan -destroy -input=false -out=tfplan \
              -target=aws_instance.main \
              -target=aws_subnet.main \
              -target=aws_vpc.main
          else
            terraform plan -input=false -out=tfplan
          fi
        working-directory: ${{ env.TF_WORKDIR }}

      - name: Terraform Show (for audit)
        run: terraform show -no-color tfplan > tfplan.txt
        working-directory: ${{ env.TF_WORKDIR }}

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            src/pages/multicloud-iac/infra/aws/tfplan
            src/pages/multicloud-iac/infra/aws/tfplan.txt
            src/pages/multicloud-iac/infra/aws/lambda_dispatch.zip

  apply:
    name: Terraform Apply or Destroy
    if: inputs.action == 'apply' || inputs.action == 'destroy'
    needs: plan
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment_name }}
    env:
      TF_WORKDIR: src/pages/multicloud-iac/infra/aws
      TF_VAR_aws_region: ${{ inputs.default_region }}
      TF_IN_AUTOMATION: 1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Export Terraform environment
        run: |
          echo "TF_STATE_BUCKET=${{ secrets.TF_STATE_BUCKET }}" >> "$GITHUB_ENV"
          echo "TF_LOCK_TABLE=${{ secrets.TF_LOCK_TABLE }}" >> "$GITHUB_ENV"
          echo "TF_VAR_github_token=${{ secrets.TF_VAR_GITHUB_TOKEN }}" >> "$GITHUB_ENV"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: ${{ github.job }}
          aws-region: ${{ inputs.default_region }}

      - name: Terraform Init
        run: |
          terraform init -input=false \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=multicloud-iac/aws/terraform.tfstate" \
            -backend-config="region=${{ inputs.default_region }}" \
            -backend-config="dynamodb_table=${TF_LOCK_TABLE}" \
            -backend-config="encrypt=true"
        working-directory: ${{ env.TF_WORKDIR }}

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: src/pages/multicloud-iac/infra/aws

      - name: Terraform Apply
        if: inputs.action == 'apply'
        run: terraform apply -input=false -auto-approve tfplan
        working-directory: ${{ env.TF_WORKDIR }}

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        run: terraform apply -input=false -auto-approve tfplan
        working-directory: ${{ env.TF_WORKDIR }}

      - name: Terraform Outputs (apply only)
        if: inputs.action == 'apply'
        run: terraform output -json > terraform-outputs.json
        working-directory: ${{ env.TF_WORKDIR }}

      - name: Upload outputs
        if: inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: src/pages/multicloud-iac/infra/aws/terraform-outputs.json
